---
import { Icon } from "astro-icon/components";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import { formatDateToYYYYMMDD } from "../utils/date-utils";
import { getCategoryUrl, getTagUrl } from "../utils/url-utils";
import { normalizeCategories } from "../utils/category-utils";

export interface Props {
	published: Date;
	updated?: Date;
    categories?: string[];
	tags?: string[];
	hideUpdateDate?: boolean;
	hideTagsForMobile?: boolean;
	isHome?: boolean;
	className?: string;
	id?: string;
	showOnlyBasicMeta?: boolean; // 新增属性，控制是否只显示基本元数据
	words?: number; // 字数统计
	minutes?: number; // 阅读时间（分钟）
	showWordCount?: boolean; // 是否显示字数统计
    cardPageUrl?: string; // 首页卡片文章链接，用于独立查询访问量
}

const {
	published,
	updated,
    categories,
	tags,
	hideUpdateDate,
	hideTagsForMobile,
	isHome,
	className = "",
	id,
	showOnlyBasicMeta = false, // 默认为false，保持原有行为
	words,
	// minutes,
	showWordCount = false, // 默认不显示字数统计
    cardPageUrl,
} = Astro.props;

const categoryList = normalizeCategories(categories);
---

<div class:list={["flex flex-wrap text-neutral-500 dark:text-neutral-400 items-center gap-4 gap-x-4 gap-y-2", className]}>
    <!-- publish date -->
    <div class="flex items-center">
        <div class="meta-icon">
            <Icon name="material-symbols:calendar-today-outline-rounded" class="text-xl"></Icon>
        </div>
        <span class="text-50 text-sm font-medium">{formatDateToYYYYMMDD(published)}</span>
    </div>

    <!-- update date -->
    {!hideUpdateDate && updated && updated.getTime() !== published.getTime() && (
        <div class="flex items-center">
            <div class="meta-icon">
                <Icon name="material-symbols:edit-calendar-outline-rounded" class="text-xl"></Icon>
            </div>
            <span class="text-50 text-sm font-medium">{formatDateToYYYYMMDD(updated)}</span>
        </div>
    )}

    <!-- categories -->
    <div class="flex items-center">
        <div class="meta-icon">
            <Icon name="material-symbols:book-2-outline-rounded" class="text-xl"></Icon>
        </div>
        <div class="flex flex-row flex-wrap items-center">
            {categoryList.length > 0 ? (
                categoryList.map((categoryItem, i) => (
                    <>
                        <div class:list={[{"hidden": i == 0}, "mx-1.5 text-[var(--meta-divider)] text-sm"]}>/</div>
                        <a href={getCategoryUrl(categoryItem)} aria-label={`View all posts in the ${categoryItem} category`}
                           class="link-lg transition text-50 text-sm font-medium
                                        hover:text-[var(--primary)] dark:hover:text-[var(--primary)] whitespace-nowrap">
                            {categoryItem}
                        </a>
                    </>
                ))
            ) : (
                <div class="transition text-50 text-sm font-medium">
                    {i18n(I18nKey.uncategorized)}
                </div>
            )}
        </div>
    </div>

    <!-- word count -->
    {showWordCount && words && (
        <div class="flex items-center">
            <div class="meta-icon">
                <Icon name="material-symbols:article-outline-rounded" class="text-xl"></Icon>
            </div>
            <span class="text-50 text-sm font-medium">
                {words} {words > 1 ? i18n(I18nKey.wordsCount) : i18n(I18nKey.wordCount)}
            </span>
        </div>
    )}

    <!-- tags (只有在不显示基本元数据时才显示) -->
    {!showOnlyBasicMeta && (
        <div class:list={["items-center", {"flex": !hideTagsForMobile, "hidden md:flex": hideTagsForMobile}]}>
            <div class="meta-icon">
                <Icon name="material-symbols:tag-rounded" class="text-xl"></Icon>
            </div>
            <div class="flex flex-row flex-nowrap items-center">
                {(tags && tags.length > 0) && tags.map((tag, i) => (
                    <>
                        <div class:list={[{"hidden": i == 0}, "mx-1.5 text-[var(--meta-divider)] text-sm"]}>/</div>
                        <a href={getTagUrl(tag)} aria-label={`View all posts with the ${tag.trim()} tag`}
                           class="link-lg transition text-50 text-sm font-medium
                                        hover:text-[var(--primary)] dark:hover:text-[var(--primary)] whitespace-nowrap">
                            {tag.trim()}
                        </a>
                    </>
                ))}
                {!(tags && tags.length > 0) && <div class="transition text-50 text-sm font-medium">{i18n(I18nKey.noTags)}</div>}
            </div>
        </div>
    )}

    <!-- 首页卡片访问量（与页面内信息栏同一行样式） -->
    {cardPageUrl && (
        <div class="flex items-center" data-vercount-card data-vercount-post-url={cardPageUrl}>
            <div class="meta-icon">
                <Icon name="material-symbols:visibility-outline-rounded" class="text-xl"></Icon>
            </div>
            <span class="text-50 text-sm font-medium">
                {i18n(I18nKey.profileStatsPageViews)} <span data-vercount-card-value>Loading</span>
            </span>
        </div>
    )}
    
    <!-- 文章页访问量 -->
    {!isHome && id && (
        <div class="flex items-center">
            <div class="meta-icon">
                <Icon name="material-symbols:visibility-outline-rounded" class="text-xl"></Icon>
            </div>
            <span class="text-50 text-sm font-medium">
                {i18n(I18nKey.profileStatsPageViews)} <span id="vercount_value_page_pv">Loading</span>
            </span>
        </div>
    )}
</div>

{!isHome && id && (
    <script is:inline>
        const VERCOUT_LOG_API = "https://events.vercount.one/api/v2/log";

        async function updateCurrentPageVercount(usePost = false) {
            const valueElement = document.getElementById("vercount_value_page_pv");
            if (!valueElement) return;

            try {
                let response;
                if (usePost) {
                    response = await fetch(VERCOUT_LOG_API, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({ url: window.location.href }),
                    });
                } else {
                    response = await fetch(
                        `${VERCOUT_LOG_API}?url=${encodeURIComponent(window.location.href)}`,
                        { method: "GET" },
                    );
                }

                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const json = await response.json();
                const payload = json?.data ?? json;
                const pagePv = Number(payload?.page_pv ?? 0);
                valueElement.textContent = Number.isFinite(pagePv)
                    ? pagePv.toLocaleString()
                    : "0";
            } catch {
                if (valueElement.textContent?.trim() === "Loading") {
                    valueElement.textContent = "0";
                }
            }
        }

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                setTimeout(() => updateCurrentPageVercount(false), 80);
            });
        } else {
            setTimeout(() => updateCurrentPageVercount(false), 80);
        }

        if (!window.__vercountSwupHookBound) {
            window.__vercountSwupHookBound = true;
            const bindSwupHook = () => {
                if (window.swup) {
                    window.swup.hooks.on("content:replace", () => {
                        setTimeout(() => updateCurrentPageVercount(true), 80);
                    });
                    return true;
                }
                return false;
            };

            if (!bindSwupHook()) {
                let retryCount = 0;
                const retryTimer = setInterval(() => {
                    if (bindSwupHook() || ++retryCount >= 10) {
                        clearInterval(retryTimer);
                    }
                }, 100);
            }
        }
    </script>
)}
