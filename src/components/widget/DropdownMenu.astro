---
import { Icon } from "astro-icon/components";
import { LinkPresets } from "../../constants/link-presets";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import type { NavBarLink, LinkPreset } from "../../types/config";
import { url } from "../../utils/url-utils";

interface Props {
	link: NavBarLink;
	class?: string;
}

const { link, class: className } = Astro.props;

const navTitleMap: Record<string, I18nKey> = {
	Links: I18nKey.navLinks,
	My: I18nKey.navMy,
	About: I18nKey.navAbout,
	Others: I18nKey.navOthers,
	Categories: I18nKey.navCategories,
	Anime: I18nKey.anime,
	Diary: I18nKey.diary,
	Gallery: I18nKey.albums,
	Devices: I18nKey.devices,
	Projects: I18nKey.projects,
	Skills: I18nKey.skills,
	Timeline: I18nKey.timeline,
	Friends: I18nKey.friends,
};

const getLocalizedName = (name: string): string => {
	return name in navTitleMap ? i18n(navTitleMap[name]) : name;
};

type ResolvedNavBarLink = Omit<NavBarLink, "children"> & {
	children?: ResolvedNavBarLink[];
};

const resolveLink = (
	target: NavBarLink | LinkPreset,
): ResolvedNavBarLink => {
	const normalized =
		typeof target === "number"
			? (LinkPresets[target] as ResolvedNavBarLink)
			: (target as ResolvedNavBarLink);
	return {
		...normalized,
		children: normalized.children?.map(resolveLink),
	};
};

const children: ResolvedNavBarLink[] = (link.children ?? []).map(resolveLink);

const hasChildren = children.length > 0;
---

<div class:list={["dropdown-container group", className]} data-dropdown>
	{
		hasChildren ? (
			<>
				<button
					class="btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95 dropdown-trigger flex items-center"
					aria-expanded="false"
					aria-haspopup="true"
					data-dropdown-trigger
				>
					{link.icon && (
						<Icon name={link.icon} class="text-[1.1rem] mr-2" />
					)}
					{getLocalizedName(link.name)}
					<Icon
						name="material-symbols:keyboard-arrow-down-rounded"
						class="text-[1.25rem] transition-transform duration-200 dropdown-arrow ml-1"
					/>
				</button>

				<div class="dropdown-menu" data-dropdown-menu>
					<div class="dropdown-content">
						{children.map((child) => (
							<div class="dropdown-item-group">
								<a
									href={
										child.external ? child.url : url(child.url)
									}
									target={child.external ? "_blank" : null}
									rel={
										child.external
											? "noopener noreferrer"
											: null
									}
									class="dropdown-item"
									aria-label={child.name}
								>
									<div class="flex items-center">
										{child.icon && (
											<Icon
												name={child.icon}
												class="text-[1rem] mr-2"
											/>
										)}
										<span>{getLocalizedName(child.name)}</span>
									</div>
									<div class="flex items-center">
										{child.external && (
											<Icon
												name="fa6-solid:arrow-up-right-from-square"
												class="text-[0.75rem] text-black/25 dark:text-white/25 ml-2"
										/>
										)}
										{child.children && child.children.length > 0 && (
											<Icon
												name="material-symbols:chevron-right-rounded"
												class="text-[1rem] text-[var(--primary)] ml-2"
											/>
										)}
									</div>
								</a>
								{child.children && child.children.length > 0 && (
									<div class="dropdown-submenu">
										{child.children.map((grand) => (
											<a
												href={
													grand.external
														? grand.url
														: url(grand.url)
												}
												target={grand.external ? "_blank" : null}
												rel={
													grand.external
														? "noopener noreferrer"
														: null
												}
												class="dropdown-item dropdown-subitem"
												aria-label={grand.name}
											>
												<div class="flex items-center">
													{grand.icon && (
														<Icon
															name={grand.icon}
															class="text-[1rem] mr-2"
														/>
													)}
													<span>
														{getLocalizedName(grand.name)}
													</span>
												</div>
												{grand.external && (
													<Icon
														name="fa6-solid:arrow-up-right-from-square"
														class="text-[0.75rem] text-black/25 dark:text-white/25 ml-2"
													/>
												)}
											</a>
										))}
									</div>
								)}
							</div>
						))}
					</div>
				</div>
			</>
		) : (
			<a
				aria-label={link.name}
				href={link.external ? link.url : url(link.url)}
				target={link.external ? "_blank" : null}
				rel={link.external ? "noopener noreferrer" : null}
				class="btn-plain scale-animation rounded-lg h-11 font-bold px-5 active:scale-95 flex items-center"
			>
				{link.icon && (
					<Icon name={link.icon} class="text-[1.1rem] mr-2" />
				)}
				{getLocalizedName(link.name)}
				{link.external && (
					<Icon
						name="fa6-solid:arrow-up-right-from-square"
						class="text-[0.875rem] transition -translate-y-[1px] ml-1 text-black/[0.2] dark:text-white/[0.2]"
					/>
				)}
			</a>
		)
	}
</div>

<style>
	.dropdown-container {
		@apply relative;
	}

	.dropdown-menu {
		@apply absolute top-full left-0 pt-2 opacity-0 invisible pointer-events-none translate-y-[-8px] transition-all duration-200 ease-out z-50;
		transition-delay: 0ms;
	}

	.dropdown-container:hover .dropdown-menu,
	.dropdown-container:focus-within .dropdown-menu,
	.dropdown-trigger[aria-expanded="true"] + .dropdown-menu {
		@apply opacity-100 visible pointer-events-auto translate-y-0;
		transition-delay: 0ms;
	}

	.dropdown-container:hover .dropdown-arrow,
	.dropdown-container:focus-within .dropdown-arrow,
	.dropdown-trigger[aria-expanded="true"] .dropdown-arrow {
		@apply rotate-180;
	}

	.dropdown-content {
		@apply relative bg-[var(--float-panel-bg)] rounded-[var(--radius-large)] shadow-xl dark:shadow-none border border-black/5 dark:border-white/10 p-2 min-w-[12rem];
	}

	.dropdown-item-group {
		@apply relative;
	}

	.dropdown-submenu {
		@apply absolute top-2 left-full opacity-0 invisible pointer-events-none translate-y-[-4px] transition-all duration-200 ease-out rounded-[var(--radius-large)] p-2 min-w-[12rem];
		background: var(--panel-bg);
		backdrop-filter: var(--panel-blur);
		box-shadow: var(--shadow-lg);
		border: none;
		transition-delay: 200ms;
	}

	.dropdown-submenu::before {
		content: "";
		position: absolute;
		left: -8px;
		top: 0;
		width: 8px;
		height: 100%;
	}

	.dropdown-item-group:hover .dropdown-submenu,
	.dropdown-item-group:focus-within .dropdown-submenu,
	.dropdown-submenu:hover {
		@apply opacity-100 visible pointer-events-auto translate-y-0;
		transition-delay: 0ms;
	}

	.dropdown-item {
		@apply flex items-center justify-between px-4 py-2.5 text-black/75 dark:text-white/75 hover:text-[var(--primary)] hover:bg-[var(--btn-plain-bg-hover)] transition-colors duration-150 font-medium rounded-lg;
	}

	.dropdown-subitem {
		@apply whitespace-nowrap min-w-[12rem];
	}

	@media (max-width: 768px) {
		.dropdown-container {
			@apply hidden;
		}
	}
</style>

<script>
	// 键盘导航支持
	document.addEventListener("DOMContentLoaded", () => {
		const dropdowns = document.querySelectorAll("[data-dropdown]");

		dropdowns.forEach((dropdown) => {
			const trigger = dropdown.querySelector(
				"[data-dropdown-trigger]",
			) as HTMLElement;
			const menu = dropdown.querySelector(
				"[data-dropdown-menu]",
			) as HTMLElement;
			const items = dropdown.querySelectorAll(
				".dropdown-item",
			) as NodeListOf<HTMLElement>;

			if (!trigger || !menu) return;

			const closeMenu = () => {
				trigger.setAttribute("aria-expanded", "false");
			};

			const toggleMenu = () => {
				const isExpanded =
					trigger.getAttribute("aria-expanded") === "true";
				trigger.setAttribute("aria-expanded", String(!isExpanded));
			};

			trigger.addEventListener("keydown", (e) => {
				if (e.key === "Enter" || e.key === " ") {
					e.preventDefault();
					toggleMenu();
				} else if (e.key === "ArrowDown") {
					e.preventDefault();
					trigger.setAttribute("aria-expanded", "true");
					if (items.length > 0) items[0].focus();
				} else if (e.key === "Escape") {
					closeMenu();
				}
			});

			// 菜单项键盘导航
			items.forEach((item, index) => {
				item.addEventListener("keydown", (e) => {
					if (e.key === "ArrowDown") {
						e.preventDefault();
						items[(index + 1) % items.length].focus();
					} else if (e.key === "ArrowUp") {
						e.preventDefault();
						items[
							(index - 1 + items.length) % items.length
						].focus();
					} else if (e.key === "Escape") {
						e.preventDefault();
						closeMenu();
						trigger.focus();
					}
				});
			});

			// 点击外部关闭
			document.addEventListener("click", (e) => {
				if (!dropdown.contains(e.target as Node)) {
					closeMenu();
				}
			});
		});
	});
</script>
